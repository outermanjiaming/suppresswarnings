<!doctype html>
<html lang="zh-cn">
<head>
    <meta name="viewport" content="initial-scale=1, user-scalable=0, minimal-ui" charset="UTF-8">
    <title>å…ˆèµä¸€ä¸ªäº¿</title>
	<link rel="stylesheet" href="asset/css/style.css">
	
    <link rel="stylesheet" href="asset/plug-ins/dist/dropload.css">
	
	<link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.3/style/weui.min.css">
	<link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.1/css/jquery-weui.min.css">
	
	<link rel="stylesheet" href="asset/plug-ins/popup_text/popup_text.css">
</head>


<body>

<!-- å¼¹å‡ºå±‚è¾“å…¥æ¡† -->
<div id="actionSheet_wrap">
    <div class="weui_mask_transition" id="actionSheet_mask" style="display: none;"></div>
    <div class="weui_actionsheet" id="weui_actionsheet">
		<div class="weui-cell" style="overflow: auto;">
			<div class="weui-cell__bd">
			  <textarea class="weui-textarea" placeholder="è¯·è¾“å…¥æ–‡æœ¬" rows="3"></textarea>
			  <!--<div class="weui-textarea-counter"><span>0</span>/200</div>-->
			</div>		
		</div>
		<div class="button_sp_area" style="float:right; margin-right:15px;">
        <button id="actionSheet_send" onclick="ajaxAddComment(this.attributes['val'].nodeValue);" class="weui-btn weui-btn_mini weui-btn_primary" style="margin-bottom:5px;">å‘é€</button>
        </div>			
    </div>
</div>


<div id="main" class="main">

	<div id ="inner" class="inner">
	
	
		<header>
			<img id="bg" src="asset/images/bg.jpg">
			<p id="user-name">ä¸‡è™ç§‘æŠ€~è´¾ç´ æ°</p>
			<a href="./user.html"><img id="avt" class="data-avt" src="asset/images/0.jpg"></a>
		</header>
	
		

		<div style="padding-top:30px;">
			<!-- å·¦è¾¹ä¸»ä½“ -->
			<div class="po-left">
				<!-- å¤´åƒ -->
				<img src="asset/images/0.jpg">
			</div>
			<!--å³è¾¹ä¸»ä½“ -->
			<div class="po-right">
				<!--postä¸»ä½“-->
				<div class="po-hd">
					<!--æ˜µç§°-->
					<p class="po-name"><span class="data-name">ä¸‡è™ç§‘æŠ€~è´¾ç´ æ°</span></p>
					<div class="post">
						<!--æ–‡æœ¬-->
						<p>å¤§å®¶å¥½ï¼Œå¬è¯´å›½å†…å†»æˆç‹—ğŸ¶ï¼Ÿæˆ‘è¿™è¾¹è¿˜æŒºçƒ­ï½å¤§å®¶å¥½ï¼Œå¬è¯´å›½å†…å†»æˆç‹—ğŸ¶ï¼Ÿæˆ‘è¿™è¾¹è¿˜æŒºçƒ­ï½å¤§å®¶å¥½ï¼Œå¬è¯´å›½å†…å†»æˆç‹—ğŸ¶ï¼Ÿæˆ‘è¿™è¾¹è¿˜æŒºçƒ­ï½</p>
						<!--å›¾ç‰‡-->
						<p>
							<img class="list-img" src="asset/images/jt1.jpg" style="height: 80px;">
							<img class="list-img" src="asset/images/yt3.jpg" style="height: 80px;">
							<img class="list-img" src="asset/images/0.jpg" style="height: 80px;">
						</p>
					</div>
					<!--æŠ•èµ„-->
					<p class="time"><img id="invest_1" onclick="ajaxAddInvest(this.id)" class="c-icon" src="asset/images/c.png" style="padding-left:10px"></p>
					<!--è½¬å‘,è¯„è®º,ç‚¹èµ-->
					<img id="transmit_1" onclick="ajaxAddTransmit(this.id)" class="c-icon" src="asset/images/c.png" style="padding-left:10px">
					<img id="comment_1" onclick="showActionSheet(this.id)" class="c-icon" src="asset/images/c.png" style="padding-left:10px">
					<img id="like_1" onclick="ajaxAddLike(this.id)" class="c-icon" src="asset/images/c.png" style="padding-left:10px">
				</div>
				<div class="triangle"></div>
				<div class="cmt-wrap">
					<!--ç‚¹èµåˆ—è¡¨-->
					<div class="likes"><img src="asset/images/l.png"><span id="likes_1">è‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œè‹äº•ç©ºï¼Œé™ˆå† å¸Œï¼Œæ¨å¹‚ï¼Œç‹æ€èªï¼Œé™ˆèµ«ï¼Œåˆ˜å¾·åï¼Œé©¬äº‘...</span></div>

					<div id="comments_1" class="cmt-list">
						<p><span>wuä¸–å‹‹-EXOï¼š</span>ë‚˜ëŠ” ì„œëª…ï½</p>
						<p><span>é¹¿æ™—ï¼š</span>æˆ‘ä»¬åœ¨å›½å†…å†»æˆç‹—ï¼Œæˆ‘ä¹Ÿæƒ³è·Ÿå“¥æ‚¨å»çƒ­çƒ­ï½</p>
						<p><span>æƒå¿—é¾™ï¼š</span>ë‚˜ëŠ” ì„œëª…ï½</p>
						<p><span>ç‹æ€èªï¼š</span>å»å“ªç©å•Šï¼Ÿé‚£ä¹ˆçˆ½</p>
						<p>
							<span class="data-name">ä¸‡è™ç§‘æŠ€~è´¾ç´ æ°</span>
							å›å¤
									<span>
										ç‹æ€èª
									</span>
									<span>
										ï¼š
									</span>
							æ¾³æ´²å¤§å ¡ç¤ï¼Œè¿™è¾¹åˆšå¥½æ˜¯å¤å­£ï¼ŒæŒºé€‚åˆé¿å¯’çš„ã€‚
						</p>
						<p><span>æ¨å¹‚ï¼š</span>ğŸ˜˜ç§äººé£æœºå‡ºè¡Œï¼Œæ±‚å¸¦ä¸Šæˆ‘ï½</p>
					</div>
				</div>
			</div>
		</div>
		

		<ul id="list">
			
		</ul>
		
	</div>
	
</div>


<script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>

<script src="asset/js/likeUiHelper.js"></script>

<script src="asset/plug-ins/dist/dropload.min.js"></script>

<script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/jquery-weui.min.js"></script>

<script src="asset/plug-ins/popup_text/popup_text.js"></script>

<script type="text/javascript">
var state = "";
var code = "";
var projectid = "";
var next = "";
var locationUrl = "";
var uname = "";
var bridgeReady = 0

$(function()
{
	var request = GetRequest();
	$.toast.prototype.defaults.duration = 700;	//è®¾ç½®toastæ˜¾ç¤ºæ—¶é—´
	
	if(request.state == undefined)
	{
	   if(request.projectid == undefined)
	   {
		 projectid = "";
	   } else {
		 projectid = request.projectid
	   }
	   locationUrl = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx41b262e9b9d8885e&redirect_uri=http://suppresswarnings.com/like.html&response_type=code&scope=snsapi_base&state="+projectid+"#wechat_redirect"
	   window.location.href = locationUrl;
	} 
	else 
	{
		state = request.state
		code = request.code
		$.ajax({
		type: 'GET',
		url: '/wx.http?action=access_token&random=random-'+state+'&ticket='+code,
		dataType: 'text',
		success: function(data)
		{
			console.log(data);
			
			if(next == "null")
			{
			    dropload.noData();
				dropload.resetload();
				return;
			}
			else
			{
				$.ajax({
					type: 'GET',
					url: '/like.http?action=project&projectid='+next+'&code='+code,
					//url: '/index/project.php?projectid='+next,
					dataType: 'json',
					success: function(data){
					    uname = data.extra.uname;
						$("#user-name").text(data.extra.uname);
						$("#avt").attr("src", data.extra.face);
						next = data.data.next;
						var result = addItems(data.data.entries);
						setTimeout(function(){
							$('#list').append(result);
							dropload.resetload();
						}, getDelayTime() );					
					},
					error: function(xhr, type){
						alert('Ajax error!');
						// å³ä½¿åŠ è½½å‡ºé”™ï¼Œä¹Ÿå¾—é‡ç½®
						dropload.resetload();
					}
				});			
			}
		},
		error: function(xhr, type){
			alert('Ajax error!');
			// å³ä½¿åŠ è½½å‡ºé”™ï¼Œä¹Ÿå¾—é‡ç½®
			dropload.resetload();
		}
		});
	}
	
if (typeof WeixinJSBridge == "undefined"){
	if( document.addEventListener ){
	    document.addEventListener('WeixinJSBridgeReady', onBridgeOK, false);
	} else if (document.attachEvent){
	    document.attachEvent('WeixinJSBridgeReady', onBridgeOK); 
	    document.attachEvent('onWeixinJSBridgeReady', onBridgeOK);
	}
}



    // dropload
    var dropload = $('.inner').dropload({
        domUp : {
            domClass   : 'dropload-up',
            domRefresh : '<div class="dropload-refresh">â†“ä¸‹æ‹‰åˆ·æ–°</div>',
            domUpdate  : '<div class="dropload-update">â†‘é‡Šæ”¾æ›´æ–°</div>',
            domLoad    : '<div class="dropload-load"><span class="loading"></span>åŠ è½½ä¸­...</div>'
        },
		
        domDown : {
            domClass   : 'dropload-down',
            domRefresh : '<div class="dropload-refresh">â†‘ä¸Šæ‹‰åŠ è½½æ›´å¤š</div>',
            domLoad    : '<div class="dropload-load"><span class="loading"></span>åŠ è½½ä¸­...</div>',
            domNoData  : '<div class="dropload-noData">æ²¡æœ‰æ›´å¤šäº†</div>'
        },
		
        loadUpFn : function(me)
		{
			setTimeout(function()
			{
				dropload.resetload();
				window.location.href = locationUrl;
			}, 1000 );
        },
		
        loadDownFn : function(me)
		{
			if(next == "null")
			{
			    dropload.noData();
				dropload.resetload();
				return;
			}
			else
			{
				$.ajax({
					type: 'GET',
					url: '/like.http?action=next&projectid='+next+'&code='+code,
					//url: '/index/project.php?projectid='+next,
					dataType: 'json',
					success: function(data){
						next = data.data.next;
						var result = addItems(data.data.entries);
						setTimeout(function(){
							$('#list').append(result);
							dropload.resetload();
						}, getDelayTime() );					
					},
					error: function(xhr, type){
						alert('Ajax error!');
						// å³ä½¿åŠ è½½å‡ºé”™ï¼Œä¹Ÿå¾—é‡ç½®
						dropload.resetload();
					}
				});			
			}
        }
    });
});



function getDelayTime()
{
	return Math.floor(Math.random()*3+1)*100;
}



function GetRequest()
{
    var url = location.search; //è·å–urlä¸­"?"ç¬¦åçš„å­—ä¸²
    var theRequest = new Object();
    if (url.indexOf("?") != -1) {
        var str = url.substr(1);
        strs = str.split("&");
        for(var i = 0; i < strs.length; i ++) {
            theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
        }
    }
    return theRequest;
}



function addItems(listData)
{
	var items = '';
	for(var i = 0; i < listData.length; i++)
	{
		items += ItemUiHelper.getItem(listData[i]);
	}
	return items;
}



function ajaxAddLike(id)
{
	var rowId = id.replace("like_", "");
	var ui = document.getElementById("likes_"+rowId);
	var uiHtml = ui.innerHTML;
	$.ajax({
		type: 'POST',
		url: '/like.http?action=like&projectid='+rowId+'&code='+code,
		dataType: 'json',
		success: function(data){
			if(data.code == 0)
			{
				$.toast("æ“ä½œæˆåŠŸ", "text");
			    if(data.data == "1") {
			        $(ui).html(uname+"ï¼Œ"+uiHtml);	
			    } else {
			        $(ui).html(uiHtml.replace(uname+"ï¼Œ", ""));
			    }
				
			}
			else
			{
				$.toast("æ“ä½œå¤±è´¥", "text");
			}
		},
		error: function(xhr, type){
			alert('Ajax error!');
		}
	});
}

function pay(gid, amt) {
  if(bridgeReady == 1) {
	  console.log("lijiaming: bridgeReady = 1")
    $.ajax({
    url: "/wx.http?r=" + Math.random(),
    data: {
	    action : "prepay",
	    random : code,
	    ticket : code,
	    goodsid: gid,
	    amount : amt
    },
    success: function( result ) {
      console.log('pay ok' + result)
      
      var prepay = JSON.parse(result)
      
      console.log('prepay.package = ' + prepay.package)
      WeixinJSBridge.invoke(
            'getBrandWCPayRequest', {
               "appId": prepay.appId,
               "timeStamp":prepay.timeStamp,
               "nonceStr":prepay.nonceStr,
               "package":prepay.package,
               "signType":prepay.signType,
               "paySign":prepay.paySign
            },
            function(res){
              console.log('res.err_msg'+res.err_msg)
              if(res.err_msg == "get_brand_wcpay_request:ok" ){
                  console.log('finish success')
				  $("#sampleData").html("æ­å–œï¼Œæ‚¨å·²ç»æ”¯ä»˜æˆåŠŸï¼")
				  location.href = "/user.html"
            }
      });

    },
    error: function( xhr, result, obj ) {
      console.log("prepay err: " + obj )
    }
  })
  } else {
    $("#btnbuy").text("æš‚æ—¶æ— æ³•æ”¯ä»˜")
  }
}

function onBridgeOK(){
  bridgeReady = 1
}



function ajaxAddComment(id)
{
	var rowId = id.replace("comment_", "");
	var text = $('#weui_actionsheet textarea')[0].value;
	hideActionSheet();
	
	var ui = document.getElementById("comments_"+rowId);
	var uiHtml = ui.innerHTML;
	ui.innerHTML = "<p><span>é¹¿æ™—ï¼š</span>æˆ‘ä»¬åœ¨å›½å†…å†»æˆç‹—ï¼Œæˆ‘ä¹Ÿæƒ³è·Ÿå“¥æ‚¨å»çƒ­çƒ­ï½</p>"+ui.innerHTML;	
	$.toast("æ“ä½œæˆåŠŸ", "text");
	/*
	$.ajax({
		type: 'POST',
		url: '/like.http?action=comment&projectid='+rowId+'&code='+code,
		dataType: 'json',
		success: function(data){
			console.log(data);
			$.toast("æ“ä½œæˆåŠŸ" + data.data, "text");
		},
		error: function(xhr, type){
			alert('Ajax error!');
		}
	});
	*/
}



function ajaxAddTransmit(id)
{

}



function ajaxAddInvest(id)
{
	$.modal({
	  text: "æŠ•èµ„çš„é‡‘é¢ç”¨äºé¼“åŠ±æ›´å¤šç”¨æˆ·ç‚¹èµï¼Œå®Œæˆä¹‹åå¯ä»¥å¾—åˆ°å¹¿å‘Šæ”¶ç›Šåˆ†çº¢",
	  title: "æŠ•èµ„é‡‘é¢",
	  buttons: [
	    { text: "1åˆ†é’±", onClick: function(){ pay("Invest001", 1);} },
	    { text: "1å…ƒé’±", onClick: function(){ pay("Invest001", 100);} },
	    { text: "å–æ¶ˆ", className: "default", onClick: function(){ console.log(3)} },
	  ],
	  onCancel: function() {
		console.log("å–æ¶ˆäº†");
	  }
	});
}
</script>
</body>
</html>